<!DOCTYPE html>
<html lang="vi">
    <head>
        <title>Profile</title>
        <link rel="stylesheet" href="/layout/sidebar.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link rel="stylesheet" href="/profile.css">
    </head>
    <body>
        
        <!-- main -->
        <div class="header"></div>
        <div class="profile__container">
            <div id="sidebar-container"></div>
            <div class="content_container">
                <div class="avatar__container d-flex align-items-center">
                    <div class="img_container">
                        <img src="../image/cat_meme.jpg" alt="avatar">
                    </div>
                    <p class="name" id="name"></p>
                    <p class="email1" id="email1"></p>
                    <button type="button" class="btn btn-primary ms-auto me-5" id="editBtn" data-bs-toggle="modal" data-bs-target="#editModal">Edit</button>
                </div>
                
                
                <div class="uni-info-container">
                    <div class="uni-info">
                        <div class="uni-info-item uni-info__mssv">
                            <label for="">MSSV</label>
                            <p class="mssv" id="mssv"></p>
                        </div>
                        <div class="uni-info-item uni-info__class">
                            <label for="">Lớp</label>
                            <p class="class" id="class"></p>
                        </div>
                        <div class="uni-info-item uni-info__status">
                            <label for="">Tình Trạng</label>
                            <p class="status" id="status"></p>
                        </div>
                    </div>
                </div>
                <h2>Thông tin cá nhân</h2>
                <div class="personal-info-container">
                    
                    <div class="personal-info">
                        <div class="personal-info-item personal-info-birth">
                            <label for="">Ngày sinh</label>
                            <p class="birth" id="birth"></p>
                        </div>
                        <div class="personal-info-item personal-info-cccd">
                            <label for="">CCCD</label>
                            <p class="cccd" id="cccd"></p>
                        </div>
                        <div class="personal-info-item personal-info-gender">
                            <label for="">Giới tính</label>
                            <p class="gender" id="gender"></p>
                        </div>
                        <div class="personal-info-item personal-info-religion">
                            <label for="">Tôn giáo</label>
                            <p class="religion" id="religion"></p>
                        </div>
                        <div class="personal-info-item personal-info-location">
                            <label for="">Thường Trú</label>
                            <p class="location" id="location"></p>
                        </div>
                        <div class="personal-info-item personal-info-email2">
                            <label for="">Email Cá Nhân</label>
                            <p class="email2" id="email2"></p>
                        </div>
                    </div>
                </div>
                <div class="info-father-container">
                    <div class="info-father">
                        <div class="personal-info-item personal-info-father">
                            <label for="">Họ tên cha</label>
                            <p class="father" id="father"></p>
                        </div>
                        <div class="personal-info-item personal-info-father_phonenumber">
                            <label for="">Số điện thoại</label>
                            <p class="father_phonenumber" id="father_phonenumber"></p>
                        </div>
                        <div class="personal-info-item personal-info-father_job">
                            <label for="">Nghề Nghiệp</label>
                            <p class="father_job" id="father_job"></p>
                        </div>
                    </div>
                </div>
                <div class="info-mother-container">
                    <div class="info-mother">
                        <div class="personal-info-item personal-info-mother">
                            <label for="">Họ tên mẹ</label>
                            <p class="mother" id="mother"></p>
                        </div>
                        <div class="personal-info-item personal-info-mother_phonenumber">
                            <label for="">Số Điện Thoại</label>
                            <p class="mother_phonenumber" id="mother_phonenumber"></p>
                        </div>
                        <div class="personal-info-item personal-info-mother_job">
                            <label for="">Nghề Nghiệp</label>
                            <p class="mother_job" id="mother_job"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                <h1 class="modal-title fs-5" id="editModalLabel">Edit your profile</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div class="mb-3">
                          <label for="edit-name" class="form-label">Họ tên</label>
                          <input type="text" class="form-control" id="edit-name">
                        </div>
                        <!-- chỉ cần edit email cá nhân -->
                        <div class="mb-3">
                          <label for="edit-email2" class="form-label">Email cá nhân</label>
                          <input type="email" class="form-control" id="edit-email2">
                        </div>
                        <div class="mb-3">
                          <label for="edit-mssv" class="form-label">MSSV</label>
                          <input type="text" class="form-control" id="edit-mssv">
                        </div>
                        <div class="mb-3">
                          <label for="edit-birth" class="form-label">Ngày sinh</label>
                          <input type="text" class="form-control" id="edit-birth">
                        </div>
                        <div class="mb-3">
                          <label for="edit-cccd" class="form-label">CCCD</label>
                          <input type="number" class="form-control" id="edit-cccd">
                        </div>
                        <div class="mb-3">
                            <label for="edit-religion" class="form-label">Tôn giáo</label>
                            <input type="text" class="form-control" id="edit-religion">
                        </div>
                        <div class="mb-3">
                            <label for="edit-gender" class="form-label">Giới tính</label>
                            <input type="text" class="form-control" id="edit-gender">
                        </div>
                        <div class="mb-3">
                            <label for="edit-location" class="form-label">Thường trú</label>
                            <input type="text" class="form-control" id="edit-location">
                        </div>
                      </form>
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveBtn">Save changes</button>
                </div>
            </div>
            </div>
        </div>
                
        <!-- javascript here -->
        <script>
            const Tai_Khoan = window.location.pathname.split('/')[2];
            console.log("Giá trị Tai_Khoan:", Tai_Khoan);
            let token = localStorage.getItem("token");

            if (!token || !Tai_Khoan) {
                document.getElementById("message").innerText = "Vui lòng đăng nhập lại!";
                setTimeout(() => window.location.href = "/login", 2000);
            } else {
                fetchStudentProfile(token, Tai_Khoan);
            }
            
            async function fetchStudentProfile(token, Tai_Khoan) {
                try {
                    console.log("Token trong localStorage:", localStorage.getItem("token"));
                    let response = await fetch(`http://localhost:3000/student/api`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${token}`
                        },
                    });
            
                    let data = await response.json();
                    if (response.ok) {
                        updateProfile(data);
                    } else {
                        document.getElementById("message").textContent = data.message;
                    }
                } catch (error) {
                    document.getElementById("message").textContent = "Lỗi tải profile!";
                }
            }
            function updateProfile(data) {
                document.getElementById("name").innerText = data.Ho_Ten || "Không có dữ liệu";
                document.getElementById("mssv").innerText = data.Ma_Sinh_Vien || "Không có dữ liệu";
                document.getElementById("gender").innerText = data.Gioi_Tinh || "Không có dữ liệu";
                document.getElementById("birth").innerText = data.Ngay_Sinh || "Không có dữ liệu";
                document.getElementById("status").innerText = data.Tinh_Trang || "Không có dữ liệu";
                document.getElementById("class").innerText = data.Ma_Lop || "Không có dữ liệu";
                document.getElementById("email1").innerText = data.Email_Truong || "Không có dữ liệu";
                document.getElementById("email2").innerText = data.Email_Ca_Nhan || "Không có dữ liệu";
                document.getElementById("cccd").innerText = data.So_CMND || "Không có dữ liệu";
                document.getElementById("religion").innerText = data.Ton_Giao|| "Không có dữ liệu";
                document.getElementById("location").innerText = data.Thuong_Tru|| "Không có dữ liệu";
                // father
                document.getElementById("father").innerText = data.Ho_Ten_Cha || "Không có dữ liệu";
                document.getElementById("father_phonenumber").innerText = data.SDT_Cha || "Không có dữ liệu";
                document.getElementById("father_job").innerText = data.Nghe_Nghiep_Cha || "Không có dữ liệu";
                // mother
                document.getElementById("mother").innerText = data.Ho_Ten_Me || "Không có dữ liệu";
                document.getElementById("mother_phonenumber").innerText = data.SDT_Me || "Không có dữ liệu";
                document.getElementById("mother_job").innerText = data.Nghe_Nghiep_Me || "Không có dữ liệu";
            }
            // EditBtn code
            const editBtn = document.getElementById("editBtn");
            
            editBtn.addEventListener('click', () => {
                // Đổ dữ liệu hiện tại vào form trong Modal
                document.getElementById('edit-name').value = document.getElementById('name').innerText;
                document.getElementById('edit-email2').value = document.getElementById('email2').innerText;
                document.getElementById('edit-mssv').value = document.getElementById('mssv').innerText;
                document.getElementById('edit-birth').value = document.getElementById('birth').innerText;
                document.getElementById('edit-cccd').value = document.getElementById('cccd').innerText;
                document.getElementById('edit-religion').value = document.getElementById('religion').innerText;
                document.getElementById('edit-gender').value = document.getElementById('gender').innerText;
                document.getElementById('edit-location').value = document.getElementById('location').innerText;
                // Hiển thị Modal
                // const editModal = new bootstrap.Modal(document.getElementById('editModal'));
                // editModal.show();
            });

            // save change button
            const saveBtn = document.getElementById("saveBtn");
            saveBtn.addEventListener("click", async() => {
                // json data của những thứ cần chỉnh sửa
                const updatedProfile = {
                    Ho_Ten: document.getElementById("edit-name").value,
                    Email_Ca_Nhan: document.getElementById('edit-email2').value,
                    Ma_Sinh_Vien: document.getElementById('edit-mssv').value,
                    Ngay_Sinh: document.getElementById('edit-birth').value,
                    So_CMND: document.getElementById('edit-cccd').value,
                    Ton_Giao: document.getElementById('edit-religion').value,
                    Gioi_Tinh: document.getElementById('edit-gender').value,
                    Thuong_Tru: document.getElementById('edit-location').value,
                };
                try {
                    const response = await fetch("http://localhost:3000/student/api",
                    {
                        method: "PUT",
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(updatedProfile)
                    });
                    // nhận dữ liệu trả về từ backend
                    const data = await response.json();
                    console.log("Data nhận được :", data);
                    if (response.ok)
                    {
                        updateProfile(data);
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                        modal.hide();
                    }
                    else {
                        alert(data.message || "Failed");
                    }
                } 
                catch (error)
                {
                    alert("Debug " + error.message);
                }
            });
            
            // fetch sidebar, đoạn này nha mấy cưng ơi, phải có ở trong mỗi page
            fetch('/layout/sidebar.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById("sidebar-container").innerHTML = html;
                setTimeout(() => {
                //  toggle sidebar
                const toggleButton = document.getElementById("toggle-btn");
                const sidebar = document.getElementById("sidebar");
                const profileContainer = document.querySelector(".profile__container");
                if (toggleButton && sidebar) {
                    toggleButton.addEventListener("click", () => {
                        sidebar.classList.toggle("collapsed");
                        profileContainer.classList.toggle("collapsed");
                    });
                }
            }, 100); 
        });
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    </body>
</html>